<!doctype html>
<html lang="da" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kiosk — Inventar 2.0</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg: #0c111b;
      --panel: #121827;
      --muted: #1a2233;
      --muted-2:#0f1624;
      --text: #e8eef7;
      --sub: #b7c3d6;
      --accent: #7aa2ff;
      --accent-2:#9bc2ff;
      --danger: #ff6b6b;
      --warn: #ffb020;
      --ok: #17c964;
      --border: #263246;
      --shadow: 0 8px 24px rgba(0,0,0,.35);
      --header-h: 0px; /* overskrives via JS */
    }
    [data-theme="light"]{
      --bg: #f7f9fc;
      --panel:#ffffff;
      --muted:#f0f3f9;
      --muted-2:#f7f9fc;
      --text:#0c1627;
      --sub:#4a5b76;
      --accent:#305dff;
      --accent-2:#5f82ff;
      --danger:#c92a2a;
      --warn:#b98900;
      --ok:#0a8f4d;
      --border:#dbe3f1;
      --shadow: 0 10px 24px rgba(11,17,27,.08);
    }

    *{ box-sizing: border-box; }
    html,body{ height: 100%; }
    body{
      margin:0; padding-top:var(--header-h);
      background: radial-gradient(80% 80% at 30% 10%, var(--muted-2), var(--bg));
      color:var(--text);
      font: 15px/1.45 system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
    }

    /* ─── Header / Toolbar ─── */
    header{
      position:fixed; inset:0 0 auto 0; z-index:1000;
      display:flex; gap:14px; align-items:center; flex-wrap:wrap;
      background: color-mix(in oklab, var(--panel) 82%, transparent);
      backdrop-filter: blur(10px) saturate(120%);
      border-bottom:1px solid var(--border);
      padding: 12px 16px;
      transform: translateY(0);
      transition: transform .25s ease;
    }
    header.hidden-on-scroll{ transform: translateY(-100%); }
    h1{ margin:0; font-size:18px; letter-spacing:.2px; }
    .toolbar{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .grow{ flex:1 1 260px; }

    .btn{ appearance:none; border:1px solid var(--border); background:var(--muted); color:var(--text);
      padding:8px 12px; border-radius:12px; cursor:pointer; font-weight:600; box-shadow: var(--shadow); white-space:nowrap; }
    .btn:hover{ border-color: color-mix(in oklab, var(--border), var(--accent) 40%); }
    .btn.primary{ background:var(--accent); border-color: transparent; color:#071021; }
    .btn.ghost{ background:transparent; }
    .btn.danger{ background:transparent; color:var(--danger); border-color: color-mix(in oklab, var(--danger), var(--border) 60%); }
    .btn.ok{ background:transparent; color:var(--ok); border-color: color-mix(in oklab, var(--ok), var(--border) 60%); }

    .field{ display:flex; align-items:center; gap:8px; background:var(--muted); border:1px solid var(--border); border-radius:12px; padding:6px 10px; }
    .field input, .field select{
      background:transparent; border:0; color:var(--text); outline:none; font: inherit; min-width:120px;
    }
    .switch{ display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px solid var(--border); border-radius:999px; }

    main{ max-width:1200px; margin: 0 auto; padding: 18px; }

    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px; }
    .tab{ padding:8px 12px; border-radius:999px; border:1px solid var(--border); background:var(--muted-2); color:var(--sub); font-weight:700; cursor:pointer; }
    .tab.active{ background:var(--accent); color:#071021; border-color:transparent; }

    .stats{ display:flex; gap:10px; flex-wrap:wrap; margin: 6px 0 12px; }
    .stat{ display:flex; gap:8px; align-items:center; background:var(--panel); border:1px solid var(--border); border-radius:12px; padding:8px 12px; }

    .grid{ display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:14px; }
    .card{ background:var(--panel); border:1px solid var(--border); border-radius:16px; overflow:hidden; display:flex; flex-direction:column; box-shadow:var(--shadow); }
    .thumb{ aspect-ratio: 16/10; background:var(--muted-2); display:block; }
    .meta{ padding:12px; display:flex; flex-direction:column; gap:8px; }
    .name{ font-weight:800; display:flex; justify-content:space-between; gap:8px; align-items:center; }
    .cat{ display:inline-flex; align-items:center; gap:6px; font-size:12px; color:var(--sub); border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .row-actions{ flex-wrap: wrap; }
    .row-actions .pill{ flex:1 1 auto; min-width: fit-content; }
    .row-actions .actions{ display:flex; gap:6px; flex-wrap:wrap; margin-left:auto; }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; background:var(--muted-2); border:1px solid var(--border); color:var(--text); white-space:nowrap; }
    .qty{ display:inline-flex; align-items:center; gap:6px; }
    .qty button{ padding:6px 10px; border-radius:10px; border:1px solid var(--border); background:var(--muted-2); color:var(--text); cursor:pointer; }
    .qty .val{ padding:4px 8px; border-radius:8px; background:var(--muted-2); border:1px solid var(--border); cursor:pointer; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border:1px solid var(--border); border-radius:10px; background:var(--muted-2); }
    .empty{ opacity:.7; border:1px dashed var(--border); padding:16px; border-radius:12px; text-align:center; }
    .low{ outline:2px solid color-mix(in oklab, var(--warn) 60%, transparent); }

    details{ background:var(--muted-2); border:1px solid var(--border); border-radius:12px; padding:8px 12px; }
    summary{ cursor:pointer; font-weight:800; }

    .list{ display:flex; flex-direction:column; gap:8px; }
    .list-item{ display:flex; justify-content:space-between; gap:12px; align-items:center; background:var(--muted-2); border:1px solid var(--border); border-radius:10px; padding:8px 10px; }

    /* Modal */
    .modal{ position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.45); z-index:2000; }
    .modal.open{ display:grid; }
    .dialog{ width:min(520px, 92vw); background:var(--panel); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: var(--shadow); }
    .dialog h2{ margin:0 0 8px; font-size:18px; }
    .dialog .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    .dialog .actions{ display:flex; justify-content:flex-end; gap:8px; margin-top:12px; }

    /* Toast */
    .toast{ position: fixed; bottom: 14px; left: 50%; transform: translateX(-50%); background: var(--panel); border:1px solid var(--border); padding:10px 14px; border-radius:10px; box-shadow: var(--shadow); display:none; }
    .toast.show{ display:block; }
  @media (max-width: 420px){
      .row-actions .actions{ width:100%; justify-content:flex-start; }
    }
  </style>
</head>
<body>
  <!-- ───────────────── Header / Controls ───────────────── -->
  <header>
    <h1>Inventar 2.0</h1>
    <div class="toolbar grow">
      <div class="field" style="flex:1">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M10 2a8 8 0 105.293 14.293l4.207 4.207 1.414-1.414-4.207-4.207A8 8 0 0010 2zm0 2a6 6 0 110 12 6 6 0 010-12z"/></svg>
        <input id="q" type="search" placeholder="Søg varer (navn, kategori)…" />
      </div>
      <div class="field">
        <label for="sort">Sortér</label>
        <select id="sort">
          <option value="name">Navn (A→Å)</option>
          <option value="stockAsc">Lager (lav→høj)</option>
          <option value="stockDesc">Lager (høj→lav)</option>
          <option value="soldDesc">Solgt (høj→lav)</option>
          <option value="updatedDesc">Senest opdateret</option>
        </select>
      </div>
      <label class="switch"><input id="onlyLow" type="checkbox"/> Kun lavt lager</label>
      <label class="switch"><input id="themeToggle" type="checkbox"/> Lys tilstand</label>
    </div>

    <div class="toolbar">
      <label class="badge">
        <span>Upload CSV</span>
        <input id="csvInput" type="file" accept=".csv,text/csv">
      </label>
      <label class="badge"><input id="cbDeduct" type="checkbox" checked><span>Fratræk salg ved upload</span></label>
      <label class="badge"><span>Importér JSON</span><input id="jsonInput" type="file" accept="application/json"></label>
      <button class="btn" id="exportJSON">Eksportér JSON</button>
      <button class="btn ghost" id="downloadTemplate">CSV-skabelon</button>
      <button class="btn" id="exportPurchases">Eksportér indkøb (CSV)</button>
      <button class="btn" id="resetSales">Nulstil solgt</button>
      <details>
        <summary>Tilføj vare</summary>
        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px">
          <input id="newName" type="text" placeholder="Varenavn" />
          <select id="newCat"></select>
          <input id="newImg" type="url" placeholder="Billede-URL (valgfrit)" />
          <input id="newImgFile" type="file" accept="image/*" capture="environment" />
          <input id="newStock" type="number" step="0.25" min="0" placeholder="Startlager" />
          <input id="newUnit" type="text" placeholder="Enhed" />
          <input id="newStep" type="number" step="0.25" min="0.25" placeholder="Trin" />
          <input id="newReorder" type="number" step="0.25" min="0" placeholder="Lav-lager grænse" />
          <button class="btn primary" id="addItem">Tilføj</button>
        </div>
      </details>
    </div>
  </header>

  <!-- ───────────────── Main ───────────────── -->
  <main>
    <div class="tabs" id="tabs"></div>

    <div class="stats">
      <div class="stat"><strong id="statCount">0</strong> varer</div>
      <div class="stat"><strong id="statLow">0</strong> lavt lager</div>
      <div class="stat"><strong id="statSold">0</strong> solgt (periode)</div>
    </div>

    <div class="grid" id="cards"></div>

    <section id="shoppingSection" style="margin-top:20px">
      <details>
        <summary>🧾 Indkøbsliste (varer under grænsen) & bulk-indkøb</summary>
        <div class="list" id="shoppingList"></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px">
          <button class="btn ok" id="purchaseSelected">Markér som købt</button>
        </div>
      </details>
    </section>

    <section id="unmatchedSection" class="hidden" style="margin-top:22px">
      <h3>Ikke matchede varer fra CSV</h3>
      <div class="list" id="unmatchedList"></div>
      <p class="badge">Tip: Klik “Tilføj” for at oprette varen og upload derefter CSV igen.</p>
    </section>

    <section style="margin-top:22px">
      <details>
        <summary>CSV-format</summary>
        <div class="badge">Forventet header (semikolon): <code>Dato;Varenr;Varenavn;Kategori;AntalSolgt;NettoOms;Moms;BruttoOms</code></div>
      </details>
      <details style="margin-top:8px">
        <summary>Indkøbslog</summary>
        <div id="purchaseLog" class="list"></div>
      </details>
    </section>
  </main>

  <!-- ───────────────── Purchase Modal ───────────────── -->
  <div class="modal" id="purchaseModal" aria-hidden="true">
    <div class="dialog">
      <h2 id="pmTitle">Markér indkøb</h2>
      <div class="grid2">
        <label>Mængde
          <input id="pmQty" type="number" step="0.25" min="0" style="width:100%"/>
        </label>
        <label>Pris (valgfri)
          <input id="pmPrice" type="number" step="0.01" min="0" style="width:100%"/>
        </label>
        <label>Notat
          <input id="pmNote" type="text" placeholder="fx leverandør / faktura" style="width:100%"/>
        </label>
        <label>Ny lav-lager grænse
          <input id="pmReorder" type="number" step="0.25" min="0" style="width:100%"/>
        </label>
      </div>
      <div class="actions">
        <button class="btn ghost" id="pmCancel">Annullér</button>
        <button class="btn primary" id="pmSave">Gem</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
    import { getDatabase, ref, onValue, set, push, update, remove, get, child }
      from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js';
    import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-storage.js';

    // ─── Firebase-konfiguration (udfyld din egen apiKey osv.) ───
    const cfg = {
      apiKey: "...",
      authDomain: "bordfodbolddtu.firebaseapp.com",
      databaseURL: "https://bordfodbolddtu-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "bordfodbolddtu",
      storageBucket: "bordfodbolddtu.firebasedatabase.app",
      messagingSenderId: "993863941891",
      appId: "1:993863941891:web:24c5c2408d254ad6d0f336"
    };
    const app = initializeApp(cfg);
    const db  = getDatabase(app);
    const storage = getStorage(app);

    // ─── DOM ───
    const hdr = document.querySelector('header');
    const tabsEl = document.getElementById('tabs');
    const cardsEl = document.getElementById('cards');
    const qEl = document.getElementById('q');
    const sortEl = document.getElementById('sort');
    const onlyLowEl = document.getElementById('onlyLow');
    const themeToggle = document.getElementById('themeToggle');

    const csvInput = document.getElementById('csvInput');
    const jsonInput = document.getElementById('jsonInput');
    const exportJSONBtn = document.getElementById('exportJSON');
    const exportPurchasesBtn = document.getElementById('exportPurchases');
    const newImgFile = document.getElementById('newImgFile');
    const resetSalesBtn = document.getElementById('resetSales');
    const downloadTplBtn = document.getElementById('downloadTemplate');

    const unmatchedSection = document.getElementById('unmatchedSection');
    const unmatchedList = document.getElementById('unmatchedList');

    const shoppingList = document.getElementById('shoppingList');
    const purchaseSelectedBtn = document.getElementById('purchaseSelected');

    const purchaseLogEl = document.getElementById('purchaseLog');

    const statCount = document.getElementById('statCount');
    const statLow = document.getElementById('statLow');
    const statSold = document.getElementById('statSold');

    const pm = {
      root: document.getElementById('purchaseModal'),
      title: document.getElementById('pmTitle'),
      qty: document.getElementById('pmQty'),
      price: document.getElementById('pmPrice'),
      note: document.getElementById('pmNote'),
      reorder: document.getElementById('pmReorder'),
      cancel: document.getElementById('pmCancel'),
      save: document.getElementById('pmSave'),
    };

    const CATS = [
      "Alle","Sodavand & Drikke","Slik","Chokolade & Barer","Chips & Snacks",
      "Popcorn","Phantom (udstyr)","Mad & Kaffen","Service & Andet","Pladsen","Rengøring"
    ];

    // udfyld kategori dropdown til ny vare
    const newCat = document.getElementById('newCat');
    CATS.slice(1).forEach(c=>{ const o=document.createElement('option'); o.textContent=c; newCat.appendChild(o); });

    // ─── State ───
    let items = {};            // id -> item
    let purchases = {};        // id -> purchase
    let activeCat = localStorage.getItem('activeCat') || 'Alle';
    let lastAction = null;     // til undo

    // Preferences
    onlyLowEl.checked = localStorage.getItem('onlyLow') === '1';
    sortEl.value = localStorage.getItem('sort') || 'name';
    qEl.value = localStorage.getItem('query') || '';
    (function initTheme(){
      const saved = localStorage.getItem('theme') || 'dark';
      document.documentElement.setAttribute('data-theme', saved);
      themeToggle.checked = saved === 'light';
    })();

    themeToggle.addEventListener('change',()=>{
      const t = themeToggle.checked ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', t);
      localStorage.setItem('theme', t);
    });

    const setHeaderHeight = () => {
      document.documentElement.style.setProperty('--header-h', hdr.offsetHeight + 'px');
    };
    setHeaderHeight();
    addEventListener('resize', setHeaderHeight);

    // ─── Live Firebase lyttere ───
    onValue(ref(db,'inventory'), snap=>{ items = snap.val() || {}; renderAll(); });
    onValue(ref(db,'purchases'), snap=>{ purchases = snap.val() || {}; renderPurchaseLog(); });

    // ─── Helpers ───
    async function compressImage(file, maxW=1400){
      return new Promise((resolve,reject)=>{
        const img=new Image(); const url=URL.createObjectURL(file);
        img.onload=()=>{ const scale=Math.min(1, maxW/img.width); const w=img.width*scale, h=img.height*scale; const c=document.createElement('canvas'); c.width=w; c.height=h; const ctx=c.getContext('2d'); ctx.drawImage(img,0,0,w,h); c.toBlob(b=>{ URL.revokeObjectURL(url); resolve(b||file); }, 'image/jpeg', 0.85); };
        img.onerror=reject; img.src=url; });
    }
    async function uploadImage(file, path){
      const small = await compressImage(file);
      const r = sRef(storage, path);
      await uploadBytes(r, small, { contentType: small.type || 'image/jpeg' });
      return await getDownloadURL(r);
    }
    async function uploadImageForItem(file, it){
      try{ return await uploadImage(file, `inventory/${it.id}.jpg`); }
      catch(err){ alert('Kunne ikke uploade billede: '+err.message); return null; }
    }
    const id = () => push(ref(db,'inventory')).key;
    const normalizeName = s => (s||"")
      .normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase()
      .replace(/[,. ;:\/()\-]/g,' ').replace(/\s+/g,' ').trim();
    const aliasToCanonical = v => {
      const n = normalizeName(v);
      if(n.includes('pepsi max')) return 'Pepsi Max 0,5L';
      if(n.includes('guldbams'))  return 'Haribo Guldbamser';
      if(n.includes('popcorn'))   return 'Mellem popcorn';
      return null;
    };
    const catEmoji = c => {
      if(c.includes('Sodavand')) return '🥤';
      if(c.includes('Popcorn'))  return '🍿';
      if(c.includes('Slik'))     return '🍬';
      if(c.includes('Barer'))    return '🍫';
      return '📦';
    };
    const placeholderSVG = (text,emoji) => {
      const svg = `\n<svg xmlns="http://www.w3.org/2000/svg" width="640" height="400">\n<defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1">\n<stop offset="0%" stop-color="#0f1a2a"/><stop offset="100%" stop-color="#1b2b45"/>\n</linearGradient></defs>\n<rect width="100%" height="100%" fill="url(#g)"/>\n<text x="50%" y="48%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="90" fill="#cfe1ff" opacity="0.9">${emoji}</text>\n<text x="50%" y="75%" dominant-baseline="middle" text-anchor="middle" font-family="system-ui" font-size="28" fill="#cfe1ff" opacity="0.9">${text}</text>\n</svg>`;
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    };

    const toast = (msg, ms=1800) => {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), ms);
    };

    const defaultReorder = () => Number(localStorage.getItem('defReorder')||'2');

    const lowFlag = it => (it.stock||0) <= (it.reorder ?? defaultReorder());

    const savePrefs = () => {
      localStorage.setItem('onlyLow', onlyLowEl.checked ? '1' : '0');
      localStorage.setItem('sort', sortEl.value);
      localStorage.setItem('query', qEl.value);
      localStorage.setItem('activeCat', activeCat);
    };

    // ─── Render ───
    function renderAll(){ renderTabs(); renderCards(); renderStats(); renderShoppingList(); }

    function renderTabs(){
      tabsEl.innerHTML = '';
      CATS.forEach(cat=>{
        const b = document.createElement('button');
        b.className = 'tab' + (cat===activeCat?' active':'');
        b.textContent = cat; b.onclick = ()=>{ activeCat=cat; savePrefs(); renderAll(); };
        tabsEl.appendChild(b);
      });
    }

    qEl.addEventListener('input', ()=>{ savePrefs(); renderCards(); });
    sortEl.addEventListener('change', ()=>{ savePrefs(); renderCards(); });
    onlyLowEl.addEventListener('change', ()=>{ savePrefs(); renderAll(); });

    function cardSort(a,b){
      switch(sortEl.value){
        case 'stockAsc': return (a.stock||0)-(b.stock||0);
        case 'stockDesc': return (b.stock||0)-(a.stock||0);
        case 'soldDesc': return (b.sold||0)-(a.sold||0);
        case 'updatedDesc': return (b.updatedAt||0)-(a.updatedAt||0);
        default: return a.name.localeCompare(b.name,'da');
      }
    }

    function matchQuery(it){
      const q = qEl.value.trim().toLowerCase();
      if(!q) return true;
      return it.name.toLowerCase().includes(q) || (it.cat||'').toLowerCase().includes(q);
    }

    function renderCards(){
      cardsEl.innerHTML = '';
      const arr = Object.values(items)
        .filter(it => (activeCat==='Alle' || it.cat===activeCat))
        .filter(it => matchQuery(it))
        .filter(it => !onlyLowEl.checked || lowFlag(it))
        .sort(cardSort);

      if(!arr.length){
        cardsEl.innerHTML = '<div class="empty">Ingen varer matcher filtrene.</div>';
        return;
      }

      arr.forEach(it=>{
        const card = document.createElement('div'); card.className = 'card' + (lowFlag(it) ? ' low' : '');
        const img = document.createElement('img'); img.className='thumb'; img.src = it.img || placeholderSVG(it.name, catEmoji(it.cat)); img.alt=it.name; card.appendChild(img);
        const meta = document.createElement('div'); meta.className='meta';

        const nameRow = document.createElement('div'); nameRow.className='name';
        const n = document.createElement('div'); n.textContent = it.name;
        const badge = document.createElement('span'); badge.className='cat'; badge.textContent = it.cat; nameRow.append(n,badge);

        const stockRow = document.createElement('div'); stockRow.className='row';
        const left = document.createElement('div'); left.className='qty';
        const minus = document.createElement('button'); minus.textContent='–'; minus.onclick=()=>changeStock(it, -(it.step||1));
        const val = document.createElement('span'); val.className='val'; val.title='Klik for at redigere';
        val.textContent = `På lager: ${(it.stock||0).toString().replace('.',',')} ${it.unit||''}`;
        val.onclick = ()=>{
          const n = prompt(`Indstil lager for "${it.name}"`, String(it.stock||0));
          if(n!==null){ const v = Math.max(0, Number(n.replace(',','.'))); update(ref(db,`inventory/${it.id}`), { stock: v, updatedAt: Date.now() }); }
        };
        const plus = document.createElement('button'); plus.textContent='+'; plus.onclick=()=>changeStock(it, it.step||1);
        left.append(minus,val,plus);
        const right = document.createElement('div'); right.className='pill'; right.textContent = `Solgt: ${it.sold||0}`;
        stockRow.append(left,right);

        const row2 = document.createElement('div'); row2.className='row row-actions';
        const info = document.createElement('div'); info.className='pill';
        const ro = (it.reorder ?? defaultReorder());
        info.textContent = `Lav-lager grænse: ${ro}`;
        info.title = 'Klik for at ændre';
        info.style.cursor='pointer';
        info.onclick = ()=>{
          const n = prompt('Ny lav-lager grænse', String(ro)); if(n===null) return;
          const v = Math.max(0, Number(n.replace(',','.')));
          update(ref(db,`inventory/${it.id}`), { reorder: v, updatedAt: Date.now() });
        };
        const actions = document.createElement('div'); actions.className='actions';
        const bImg = (function(){
          const input = document.createElement('input');
          input.type='file'; input.accept='image/*'; input.capture='environment'; input.style.display='none';
          card.appendChild(input);
          input.onchange = async (e)=>{ const f=e.target.files[0]; if(!f) return; const url = await uploadImageForItem(f, it); if(url) update(ref(db,`inventory/${it.id}`), { img:url, updatedAt: Date.now() }); };
          return btn('Skift billede','ghost', ()=> input.click());
        })(); if(url!==null) update(ref(db,`inventory/${it.id}`), { img:url.trim(), updatedAt: Date.now() }); });
        const bUnit = btn('Enhed/trin','ghost', ()=>{
          const u = prompt('Enhed:', it.unit||''); if(u===null) return;
          const s = prompt('Trin:', String(it.step||1)); if(s===null) return;
          update(ref(db,`inventory/${it.id}`), { unit:u.trim(), step:Math.max(0.01, Number(s.replace(',','.'))), updatedAt: Date.now() });
        });
        const bBuy = btn('Købt ind','ok', ()=> openPurchaseModal(it));
        const bDel = btn('Fjern','danger', ()=>{ if(confirm(`Fjern ${it.name}?`)) remove(ref(db,`inventory/${it.id}`)); });
        actions.append(bImg,bUnit,bBuy,bDel);
        row2.append(info, actions);

        meta.append(nameRow, stockRow, row2);
        card.appendChild(meta);
        cardsEl.appendChild(card);
      });
    }

    function btn(label, cls, on){ const b=document.createElement('button'); b.className='btn '+cls; b.textContent=label; b.onclick=on; return b; }

    function renderStats(){
      const arr = Object.values(items);
      statCount.textContent = arr.length;
      statLow.textContent = arr.filter(lowFlag).length;
      statSold.textContent = arr.reduce((s,it)=>s+(it.sold||0),0);
    }

    function renderShoppingList(){
      shoppingList.innerHTML = '';
      const low = Object.values(items).filter(lowFlag).sort((a,b)=> (a.cat||'').localeCompare(b.cat||'', 'da'));
      if(!low.length){ shoppingList.innerHTML = '<div class="empty">Ingen varer under grænsen 🎉</div>'; return; }
      low.forEach(it=>{
        const row = document.createElement('div'); row.className='list-item';
        const left = document.createElement('div'); left.innerHTML = `<strong>${it.name}</strong><br><span style="opacity:.8">${it.cat} • Lager: ${it.stock||0} ${it.unit||''} • Grænse: ${it.reorder ?? defaultReorder()}</span>`;
        const right = document.createElement('div'); right.style.display='flex'; right.style.gap='6px'; right.style.alignItems='center';
        const qty = document.createElement('input'); qty.type='number'; qty.step='0.25'; qty.min='0'; qty.placeholder='Køb mængde'; qty.style.width='120px';
        qty.value = Math.max(0, (it.reorder ?? defaultReorder()) - (it.stock||0));
        const price = document.createElement('input'); price.type='number'; price.step='0.01'; price.min='0'; price.placeholder='Pris (valgfri)'; price.style.width='120px';
        const note = document.createElement('input'); note.type='text'; note.placeholder='Notat'; note.style.width='160px';
        const b = document.createElement('button'); b.className='btn ok'; b.textContent='Købt'; b.onclick=()=> handlePurchase(it, Number(qty.value||0), Number(price.value||0)||null, note.value.trim()||null, null);
        right.append(qty, price, note, b);
        row.append(left,right);
        shoppingList.append(row);
      });
    }

    purchaseSelectedBtn.addEventListener('click', async()=>{
      const rows = shoppingList.querySelectorAll('.list-item');
      let count=0; for(const row of rows){
        const [qtyEl, priceEl, noteEl] = row.querySelectorAll('input');
        const name = row.querySelector('strong').textContent;
        const it = Object.values(items).find(x=>x.name===name);
        if(!it) continue; const qty = Number(qtyEl.value||0); if(qty>0){
          await handlePurchase(it, qty, Number(priceEl.value||0)||null, noteEl.value.trim()||null, null);
          count++;
        }
      }
      toast(`Markerede ${count} indkøb`);
    });

    function renderPurchaseLog(){
      purchaseLogEl.innerHTML = '';
      const arr = Object.values(purchases||{}).sort((a,b)=> (b.ts||0)-(a.ts||0)).slice(0,50);
      if(!arr.length){ purchaseLogEl.innerHTML='<div class="empty">Ingen indkøb registreret endnu.</div>'; return; }
      arr.forEach(p=>{
        const row = document.createElement('div'); row.className='list-item';
        const left = document.createElement('div');
        const d = new Date(p.ts||Date.now());
        left.innerHTML = `<strong>${p.name}</strong><br><span style="opacity:.8">${d.toLocaleString('da-DK')} • +${p.qty} ${p.unit||''} ${p.price?`• ${p.price.toFixed(2)} kr`:''} ${p.note?`• ${p.note}`:''}</span>`;
        const right = document.createElement('div');
        const undo = btn('Fortryd','ghost',()=> undoPurchase(p));
        right.append(undo);
        row.append(left,right);
        purchaseLogEl.append(row);
      });
    }

    async function undoPurchase(p){
      const itemRef = ref(db, `inventory/${p.itemId}`);
      const snap = await get(itemRef); const it = snap.val(); if(!it) return;
      const newStock = Math.max(0, (it.stock||0) - p.qty);
      await update(itemRef, { stock: newStock, updatedAt: Date.now() });
      await remove(ref(db, `purchases/${p.id}`));
      toast('Indkøb fortrudt');
    }

    function changeStock(it, delta){
      const newStock = Math.max(0, +(((it.stock||0) + delta).toFixed(3)));
      update(ref(db,`inventory/${it.id}`), { stock: newStock, updatedAt: Date.now() });
    }

    // ─── Purchase modal ───
    let modalItem = null;
    function openPurchaseModal(it){
      modalItem = it; pm.title.textContent = `Købt ind – ${it.name}`;
      pm.qty.value = it.step || 1; pm.price.value = ''; pm.note.value=''; pm.reorder.value = (it.reorder ?? defaultReorder());
      pm.root.classList.add('open'); pm.root.setAttribute('aria-hidden','false');
    }
    pm.cancel.onclick = ()=>{ pm.root.classList.remove('open'); pm.root.setAttribute('aria-hidden','true'); };
    pm.save.onclick = ()=>{
      const qty = Math.max(0, Number(pm.qty.value||0));
      const price = Number(pm.price.value||0)||null;
      const note = pm.note.value.trim()||null;
      const re = Number(pm.reorder.value||NaN); const newReorder = isNaN(re) ? null : re;
      handlePurchase(modalItem, qty, price, note, newReorder);
      pm.cancel.click();
    };
    addEventListener('keydown', e=>{ if(e.key==='Escape' && pm.root.classList.contains('open')) pm.cancel.click(); });

    async function handlePurchase(it, qty, price, note, reorder){
      if(!it || qty<=0) return;
      const newStock = (it.stock||0) + qty;
      const upd = { stock: newStock, updatedAt: Date.now() };
      if(reorder!==null && reorder!==undefined) upd.reorder = reorder;
      await update(ref(db,`inventory/${it.id}`), upd);

      const pId = push(ref(db,'purchases')).key;
      const p = { id:pId, itemId: it.id, name: it.name, unit: it.unit||'', qty, price: price||null, note: note||null, ts: Date.now() };
      await set(ref(db,`purchases/${pId}`), p);
      lastAction = { type:'purchase', purchase:p };
      toast(`+${qty} ${it.unit||''} til ${it.name}`);
    }

    // ─── CSV import ───
    const CSV_HEADER = ["dato","varenr","varenavn","kategori","antalsolgt","nettooms","moms","bruttooms"];
    csvInput.addEventListener('change', async e=>{
      const file = e.target.files[0]; if(!file) return; const text = await file.text(); applyCSV(text, document.getElementById('cbDeduct').checked); csvInput.value=''; });

    function parseCSV(text){
      const lines = text.replace(/\r\n/g,'\n').split('\n').filter(l=>l.trim());
      const rows=[]; for(const line of lines){ const out=[]; let cur='', inQ=false; for(const ch of line){ if(ch==='"'){ inQ=!inQ; continue; } if(ch===';' && !inQ){ out.push(cur); cur=''; continue; } cur+=ch; } out.push(cur); rows.push(out); } return rows;
    }
    async function applyCSV(txt, deduct){
      const rows = parseCSV(txt); if(!rows.length){ alert('CSV tom'); return; }
      const header = rows[0].map(h=>h.trim().toLowerCase());
      if(!CSV_HEADER.every((h,i)=>header[i]===h)){
        if(!confirm('Header matcher ikke. Fortsæt?')) return;
      }
      const sums = new Map();
      for(let i=1;i<rows.length;i++){
        const r=rows[i]; if(r.length<5) continue;
        const name=r[2].trim(); const qty = Number(r[4].replace(/\./g,'').replace(',','.'));
        if(!name || !isFinite(qty)) continue;
        sums.set(name, (sums.get(name)||0)+qty);
      }
      const unmatched=[];
      sums.forEach((qty,csvName)=>{
        const canon = aliasToCanonical(csvName)||csvName;
        const entry = Object.values(items).find(it=>normalizeName(it.name)===normalizeName(canon));
        if(entry){
          const soldNew = (entry.sold||0)+qty;
          const stockNew = deduct ? Math.max(0, (entry.stock||0)-qty) : (entry.stock||0);
          update(ref(db,`inventory/${entry.id}`), { sold: soldNew, stock: stockNew, updatedAt: Date.now() });
        } else {
          unmatched.push({ name: csvName, sold: qty });
        }
      });
      renderUnmatched(unmatched);
      toast('CSV anvendt');
    }
    function renderUnmatched(arr){
      unmatchedList.innerHTML='';
      if(!arr.length){ unmatchedSection.classList.add('hidden'); return; }
      unmatchedSection.classList.remove('hidden');
      arr.forEach(u=>{
        const row=document.createElement('div'); row.className='list-item';
        const left=document.createElement('div'); left.innerHTML = `<strong>${u.name}</strong><br><span style="opacity:.8">Solgt: ${u.sold}</span>`;
        const right=document.createElement('div'); right.style.display='flex'; right.style.gap='6px';
        const sel=document.createElement('select'); CATS.slice(1).forEach(c=>{ const o=document.createElement('option'); o.textContent=c; sel.appendChild(o); });
        const unit=document.createElement('input'); unit.type='text'; unit.placeholder='Enhed'; unit.style.width='100px';
        const step=document.createElement('input'); step.type='number'; step.step='0.25'; step.min='0.01'; step.placeholder='Trin'; step.style.width='90px';
        const ro=document.createElement('input'); ro.type='number'; ro.step='0.25'; ro.min='0'; ro.placeholder='Lav-lager'; ro.style.width='90px'; ro.value = defaultReorder();
        const btnAdd=btn('Tilføj','primary',()=>{
          const newId = id();
          const entry = { id:newId, name:u.name, cat:sel.value, img:'', sold:u.sold, stock:0, unit:unit.value||'stk', step:Math.max(0.01, Number(step.value||1)), reorder:Number(ro.value||defaultReorder()), updatedAt: Date.now() };
          set(ref(db,`inventory/${newId}`), entry); row.remove(); if(!unmatchedList.children.length) unmatchedSection.classList.add('hidden');
        });
        right.append(sel,unit,step,ro,btnAdd); row.append(left,right); unmatchedList.append(row);
      });
    }

    // ─── JSON import/export ───
    jsonInput.addEventListener('change', async e=>{
      const file = e.target.files[0]; if(!file) return;
      try{
        const txt = await file.text(); const data = JSON.parse(txt); if(!Array.isArray(data.items)) throw new Error('Forkert format');
        set(ref(db,'inventory'), {});
        data.items.forEach(x=>{
          const newId = x.id || id();
          const entry = { id:newId, name:x.name, cat:x.cat, img:x.img||'', sold:0, stock:x.stock||0, unit:x.unit||'', step:x.step||1, reorder: x.reorder ?? defaultReorder(), updatedAt: Date.now() };
          set(ref(db,`inventory/${newId}`), entry);
        });
        alert(`Importeret ${data.items.length} varer`);
      }catch(err){ alert('Kunne ikke importere JSON: '+ err.message); }
      finally{ jsonInput.value=''; }
    });

    exportJSONBtn.addEventListener('click', ()=>{
      const data = { items: Object.values(items) };
      const blob = new Blob([JSON.stringify(data,null,2)], { type:'application/json' });
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='inventar_export.json'; a.click(); URL.revokeObjectURL(a.href);
    });

    exportPurchasesBtn.addEventListener('click', ()=>{
      const arr = Object.values(purchases||{}).sort((a,b)=> (a.ts||0)-(b.ts||0));
      const rows = [['DatoTid','Varenavn','Mængde','Enhed','Pris','Notat']].concat(
        arr.map(p=>[
          new Date(p.ts).toLocaleString('da-DK'), p.name, String(p.qty).replace('.',','), p.unit||'', p.price!=null?p.price.toFixed(2).replace('.',','):'', p.note||''
        ])
      );
      const csv = rows.map(r=> r.map(v=> typeof v==='string' && v.includes(';') ? '"'+v.replace('"','""')+'"' : v).join(';')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='indkoeb_log.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    resetSalesBtn.addEventListener('click', ()=>{ if(!confirm('Nulstil solgt for alle?')) return; Object.values(items).forEach(it=> update(ref(db,`inventory/${it.id}`), { sold:0, updatedAt: Date.now() })); });

    downloadTplBtn.addEventListener('click', ()=>{
      const tpl = [
        'Dato;Varenr;Varenavn;Kategori;AntalSolgt;NettoOms;Moms;BruttoOms',
        '2025-08-01;P001;Lille popcorn;Snacks;8;240,00;60,00;300,00',
        '2025-08-01;D021;Pepsi Max 0,5L;Sodavand;5;76,00;19,00;95,00'
      ].join('\n');
      const blob = new Blob([tpl],{type:'text/csv'});
      const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='kiosk_eksempel.csv'; a.click(); URL.revokeObjectURL(a.href);
    });

    // ─── Add item ───
    document.getElementById('addItem').addEventListener('click', async ()=>{
      const base = {
        id: id(),
        name: document.getElementById('newName').value.trim(),
        cat: newCat.value,
        stock: Number(document.getElementById('newStock').value||0),
        unit: document.getElementById('newUnit').value.trim()||'stk',
        step: Math.max(0.01, Number(document.getElementById('newStep').value||1)),
        reorder: Number(document.getElementById('newReorder').value||defaultReorder()),
        sold: 0,
        updatedAt: Date.now(),
      };
      if(!base.name){ alert('Varenavn mangler'); return; }
      let imgUrl = document.getElementById('newImg').value.trim();
      if(newImgFile && newImgFile.files && newImgFile.files[0]){
        imgUrl = await uploadImage(newImgFile.files[0], `inventory/${base.id}.jpg`);
      }
      const entry = { ...base, img: imgUrl };
      await set(ref(db,`inventory/${entry.id}`), entry);
      toast('Vare tilføjet');
      ['newName','newImg','newStock','newUnit','newStep','newReorder'].forEach(id=> document.getElementById(id).value='');
      if(newImgFile) newImgFile.value='';
    });

    // ─── Scroll hide header ───
    let lastY = pageYOffset; addEventListener('scroll',()=>{ const y = pageYOffset; if(y>lastY+5){ hdr.classList.add('hidden-on-scroll'); } else if(y<lastY-5){ hdr.classList.remove('hidden-on-scroll'); } lastY=y; });

    // Restore active tab
    const ac = localStorage.getItem('activeCat'); if(ac) activeCat = ac;
  </script>
</body>
</html>
